<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>brAIn - Tümör Analizi</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <style>
        :root {
            --bg-color: #121829;
            --card-color: rgba(38, 45, 69, 0.7);
            --primary-text: #FFFFFF;
            --secondary-text: #A1A8B8;
            --accent-color: #4A4DE6;
            --error-color: #FF5B5B;
            --success-color: #00C48C;
            --warning-color: #FFC700;
            --outlier-color: #FFA500;
            --border-color: rgba(255, 255, 255, 0.1);
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--primary-text); margin: 0; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; text-align: center; }
        .card { background: var(--card-color); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 24px; border: 1px solid var(--border-color); padding: 32px; width: 100%; max-width: 480px; transition: all 0.3s ease; }
        .state { display: none; }
        .state.active { display: block; }
        .upload-title { font-size: 18px; font-weight: 600; margin: 0; }
        .upload-subtitle { font-size: 14px; color: var(--secondary-text); margin-top: 4px; }
        .upload-options { display: flex; gap: 12px; margin-top: 24px; }
        .upload-options > * { flex: 1; }
        #drop-zone { border: 2px dashed var(--secondary-text); border-radius: 16px; padding: 20px; cursor: pointer; transition: background-color 0.3s ease; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; box-sizing: border-box; }
        #drop-zone:hover { background-color: rgba(255, 255, 255, 0.05); }
        #drop-zone svg { color: var(--accent-color); margin-bottom: 8px; }
        #drop-zone span { font-size: 14px; font-weight: 500; }
        input[type="file"] { display: none; }
        .btn { width: 100%; padding: 12px; font-size: 16px; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; transition: background-color 0.3s ease; display: flex; justify-content: center; align-items: center; gap: 8px; line-height: 1; }
        .btn-primary { background-color: var(--accent-color); color: var(--primary-text); }
        .btn-primary:hover { background-color: #3a3dc5; }
        .file-info-card { background-color: rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 12px; text-align: left; }
        .file-icon { flex-shrink: 0; padding: 8px; background-color: var(--accent-color); border-radius: 8px; }
        .progress-bar-container { width: 100%; height: 6px; background-color: rgba(0, 0, 0, 0.3); border-radius: 3px; margin-top: 12px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background-color: var(--accent-color); border-radius: 3px; transition: width 0.5s ease; }
        #error-state .file-icon { background-color: var(--error-color); }
        .results-title { font-size: 20px; font-weight: 600; margin-bottom: 16px; text-align: left; }
        .thumbnail-gallery { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; flex-wrap: wrap; }
        .thumbnail { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; cursor: pointer; border: 2px solid transparent; transition: all 0.3s; opacity: 0.7; }
        .thumbnail:hover { opacity: 1; transform: scale(1.05); }
        .thumbnail.active { border-color: var(--accent-color); opacity: 1; }
        .thumbnail.outlier { border-color: var(--outlier-color); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); z-index: 100; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: var(--card-color); padding: 20px; border-radius: 16px; max-width: 600px; width: 95%; text-align: center; border: 1px solid var(--border-color); }
        .modal-content h2 { margin-top: 0; font-size: 18px; }
        .modal-content p { color: var(--secondary-text); }
        #heatmap-container { position: relative; margin: 15px auto; max-width: 512px; }
        #heatmap-image { width: 100%; height: auto; display: block; border-radius: 8px; }
        #heatmap-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.6; border-radius: 8px; }
        #heatmap-status { min-height: 20px; font-style: italic; color: var(--secondary-text); }
    </style>
</head>
<body>
    <header class="header"><h1>brAIn</h1><p data-key="headerSubtitle">Tümör Sınıflandırıcı</p></header>
    
    <div id="heatmap-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 data-key="heatmapTitle">Isı Haritası Analizi</h2>
            <div id="heatmap-container">
                <img id="heatmap-image" src="#" crossorigin="anonymous" alt="Heatmap Görüntüsü" />
                <canvas id="heatmap-canvas"></canvas>
            </div>
            <p id="heatmap-status"></p>
            <button id="close-heatmap-modal-btn" class="btn btn-primary" data-key="btnClose">Kapat</button>
        </div>
    </div>

    <main class="card" id="main-card">
        <div id="default-state" class="state active">
            <h3 class="upload-title" data-key="uploadTitle">MR Taramalarınızı Yükleyin</h3>
            <p class="upload-subtitle" data-key="uploadSubtitle">Birden fazla dosya seçin veya kameranızı kullanın</p>
            <div class="upload-options">
                <label for="file-input" id="drop-zone">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M19.5 14.25V14.25C19.5 15.2165 18.7165 16 17.75 16H13V19.25C13 19.6642 12.6642 20 12.25 20H10.75C10.3358 20 10 19.6642 10 19.25V16H5.25C4.2835 16 3.5 15.2165 3.5 14.25V14.25C3.5 13.2835 4.2835 12.5 5.25 12.5H5.66919C5.83538 12.5 5.99216 12.4042 6.07198 12.2591C6.77241 11.085 7.91424 10.25 9.25 10.25H9.5V8.75C9.5 7.3769 10.6269 6.25 12 6.25C13.3731 6.25 14.5 7.3769 14.5 8.75V12.5H17.75C18.7165 12.5 19.5 13.2835 19.5 14.25Z"/></svg>
                    <span data-key="btnChooseFiles">Dosya Seç</span>
                </label>
                <button id="camera-btn" class="btn btn-primary">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM12 14C13.1046 14 14 13.1046 14 12C14 10.8954 13.1046 10 12 10C10.8954 10 10 10.8954 10 12C10 13.1046 10.8954 14 12 14Z" fill="white"/><path fill-rule="evenodd" clip-rule="evenodd" d="M3 6C3 4.34315 4.34315 3 6 3H18C19.6569 3 21 4.34315 21 6V18C21 19.6569 19.6569 21 18 21H6C4.34315 21 3 19.6569 3 18V6ZM6 5H18C18.5523 5 19 5.44772 19 6V18C19 18.5523 18.5523 19 18 19H6C5.44772 19 5 18.5523 5 18V6C5 5.44772 5.44772 5 6 5Z" fill="white"/></svg>
                    <span data-key="btnUseCamera">Kamera Kullan</span>
                </button>
            </div>
            <input type="file" id="file-input" accept="image/*" multiple>
        </div>
        <div id="uploading-state" class="state">
            <div class="file-info-card">
                <div class="file-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" fill="white"/></svg></div>
                <div class="file-details"><div id="file-name" class="file-name"></div><div id="file-status" class="file-status"></div></div>
            </div>
            <div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div>
        </div>
        <div id="error-state" class="state">
            <div class="file-info-card">
                <div class="file-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" fill="white"/></svg></div>
                <div class="file-details"><div class="file-name" data-key="errorTitle">Hata</div><div class="file-status" data-key="errorText">Lütfen geçerli resim dosyaları yükleyin.</div></div>
            </div>
            <button id="try-again-btn" class="btn btn-primary"><span data-key="btnTryAgain">Tekrar Dene</span></button>
        </div>
        <div id="result-state" class="state">
            </div>
    </main>
<script>
    const URL = "./model/";
    const CONFIDENCE_THRESHOLD = 0.50;
    let model, webcamStream;
    let batchResults = [], invalidImages = [];

    // --- DOM Elementleri ---
    const fileInput = document.getElementById('file-input');
    const dropZone = document.getElementById('drop-zone');
    const cameraBtn = document.getElementById('camera-btn');
    const states = {
        default: document.getElementById('default-state'),
        uploading: document.getElementById('uploading-state'),
        error: document.getElementById('error-state'),
        result: document.getElementById('result-state'),
    };
    const fileNameEl = document.getElementById('file-name');
    const fileStatusEl = document.getElementById('file-status');
    const progressBar = document.getElementById('progress-bar');
    const tryAgainBtn = document.getElementById('try-again-btn');
    
    // Heatmap Modal Elementleri
    const heatmapModal = document.getElementById('heatmap-modal');
    const heatmapImage = document.getElementById('heatmap-image');
    const heatmapCanvas = document.getElementById('heatmap-canvas');
    const heatmapStatus = document.getElementById('heatmap-status');
    const closeHeatmapModalBtn = document.getElementById('close-heatmap-modal-btn');

    // --- State Yönetimi ---
    function showState(stateName) {
        Object.values(states).forEach(state => state.classList.remove('active'));
        states[stateName]?.classList.add('active');
    }

    // --- Model Yükleme ---
    async function loadModel() {
        try {
            model = await tmImage.load(URL + "model.json", URL + "metadata.json");
            console.log("Model başarıyla yüklendi.");
        } catch (error) {
            console.error("Model yüklenemedi:", error);
            showState('error');
            document.querySelector('#error-state .file-status').textContent = "Model yüklenemedi. Lütfen internet bağlantınızı kontrol edin ve sayfayı yenileyin.";
        }
    }

    // --- Analiz ve Dosya İşlemleri ---
    function handleFiles(files) {
        const imageFiles = Array.from(files).filter(f => f.type.startsWith("image/"));
        if (imageFiles.length === 0) {
            showState('error');
            return;
        }
        runBatchAnalysis(imageFiles);
    }
    
    async function runBatchAnalysis(files) {
        batchResults = []; 
        invalidImages = []; 
        showState('uploading');
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            fileNameEl.textContent = `Analiz ediliyor: ${i + 1} / ${files.length}`;
            fileStatusEl.textContent = file.name;
            progressBar.style.width = `${((i + 1) / files.length) * 100}%`;

            const imageSrc = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
            const img = await new Promise(resolve => {
                const image = new Image();
                image.src = imageSrc;
                image.onload = () => resolve(image);
            });
            
            const predictions = await model.predict(img);
            const topPred = predictions.sort((a,b) => b.probability - a.probability)[0];
            
            if(topPred.probability >= CONFIDENCE_THRESHOLD){ 
                batchResults.push({ imageSrc, predictions }); 
            } else { 
                invalidImages.push(imageSrc); 
            }
        }
        displayBatchResults();
    }

    // --- Sonuçları Gösterme ---
    function displayBatchResults() {
        showState('result');
        const resultContainer = states.result;
        let resultHTML = '<div id="result-content">';

        if (batchResults.length > 0) {
            // Ortalama sonuçları hesapla (opsiyonel, şimdilik ilk resmin sonucunu gösterelim)
            const firstResultPreds = batchResults[0].predictions.map(p => ({...p, probability: p.probability * 100}));
            const topPrediction = firstResultPreds.sort((a,b) => b.probability - a.probability)[0];

            resultHTML += `<h3 class="results-title">Analiz Sonuçları</h3>`;
            firstResultPreds.forEach((p, index) => {
                resultHTML += `
                    <div class="prediction-item ${index === 0 ? 'top-prediction' : ''}">
                        <div class="prediction-label">${p.className}</div>
                        <div class="prediction-bar-bg">
                            <div class="prediction-bar" style="width: ${p.probability.toFixed(1)}%; background-color: ${index === 0 ? 'var(--success-color)' : 'var(--accent-color)'};">${p.probability.toFixed(1)}%</div>
                        </div>
                    </div>
                `;
            });

            // Detaylı Döküm
            if (batchResults.length > 0) {
                resultHTML += `<h3 class="results-title" style="font-size: 18px; margin-top: 20px;">Detaylı Döküm</h3>`;
                resultHTML += `<div class="thumbnail-gallery">`;
                batchResults.forEach((result, index) => {
                    resultHTML += `<img src="${result.imageSrc}" class="thumbnail" data-index="${index}">`;
                });
                resultHTML += `</div>`;
            }
        }

        if (invalidImages.length > 0) {
            resultHTML += `<h3 class="results-title" style="font-size: 16px; color: var(--warning-color); margin-top: 20px;">Analiz İçin Uygun Değil</h3>`;
            resultHTML += `<div class="thumbnail-gallery">`;
            invalidImages.forEach(src => {
                resultHTML += `<img src="${src}" class="thumbnail" style="opacity: 0.5; cursor: default;">`;
            });
            resultHTML += `</div>`;
        }
        
        if (batchResults.length === 0 && invalidImages.length > 0) {
            resultHTML += `<p>Yüklenen resimlerin hiçbiri analiz için uygun bulunmadı.</p>`;
        } else if (batchResults.length === 0 && invalidImages.length === 0) {
             resultHTML += `<p>Analiz edilecek sonuç bulunamadı.</p>`;
        }


        resultHTML += `</div><div class="result-buttons" style="margin-top: 24px;"><button id="scan-another-btn" class="btn btn-primary">Başka Görüntü Tara</button></div>`;
        resultContainer.innerHTML = resultHTML;
        
        // Sonradan eklenen butonlar için event listener'ları yeniden ata
        document.getElementById('scan-another-btn').addEventListener('click', resetApp);
        document.querySelectorAll('.thumbnail[data-index]').forEach(thumb => {
            thumb.addEventListener('click', (e) => {
                const index = e.target.dataset.index;
             async function generateAndShowHeatmap(imageSrc) {
        heatmapModal.classList.add('visible');
        heatmapStatus.textContent = "Isı Haritası Oluşturuluyor...";
        heatmapImage.src = imageSrc;

        await new Promise(resolve => {
            heatmapImage.onload = resolve;
            if (heatmapImage.complete) resolve();
        });
        
        heatmapCanvas.width = heatmapImage.clientWidth;
        heatmapCanvas.height = heatmapImage.clientHeight;

        try {
            const underlyingModel = model.model;

            // --- FİNAL DEĞİŞİKLİK: DERİN ARAMA ---
            // Modelin içindeki asıl görsel modelini (genellikle ilk katmandır) bul.
            const visionModelLayer = underlyingModel.layers[0];
            
            // Eğer bu bir alt model ise, onun İÇİNDEKİ katmanları ara. Değilse, ana modelin katmanlarını kullan.
            const layersToSearch = visionModelLayer.layers || underlyingModel.layers;
            
            console.log("Aranacak Katman Sayısı:", layersToSearch.length);

            // Bu katman listesi içinden son 'conv_pw_..._relu' katmanını DİNAMİK olarak bul.
            const allConvLayers = layersToSearch.filter(layer => 
                layer.name.includes('conv_pw') && layer.name.includes('relu')
            );
            
            const targetLayer = allConvLayers.length > 0 ? allConvLayers[allConvLayers.length - 1] : null;
            // --- FİNAL DEĞİŞİKLİK BİTTİ ---

            if (!targetLayer) {
                heatmapStatus.textContent = "Hata: Modelin içinde heatmap için uygun katman bulunamadı.";
                console.error("Uygun katman bulunamadı. Model mimarisi beklenenden farklı olabilir.");
                // Hata ayıklama için tüm katmanları ve alt katmanları yazdır.
                console.log("Üst Seviye Katmanlar:", underlyingModel.layers.map(l => l.name));
                underlyingModel.layers.forEach(l => {
                    if(l.layers) console.log(`'${l.name}' içindeki alt katmanlar:`, l.layers.map(sl => sl.name));
                });
                return;
            }
            
            console.log("Hedef Heatmap Katmanı Olarak Seçildi:", targetLayer.name);

            const activationModel = tf.model({
                inputs: underlyingModel.inputs,
                outputs: [targetLayer.output, underlyingModel.output]
            });

            const imageTensor = tf.tidy(() => {
                const tensor = tf.browser.fromPixels(heatmapImage).toFloat();
                const offset = tf.scalar(127.5);
                return tensor.sub(offset).div(offset).expandDims();
            });

            const { convOutput, grads } = tf.tidy(() => {
                function getGrads() {
                    const [convOutput, predictions] = activationModel.predict(imageTensor);
                    const topClassIndex = predictions.argMax(-1).dataSync()[0];
                    const topClassScore = predictions.gather([topClassIndex], 1);
                    const grads = tf.grad(p => p.sum())(topClassScore, convOutput);
                    return { convOutput: convOutput.squeeze(), grads: grads.squeeze() };
                }
                return getGrads();
            });

            const heatmapTensor = tf.tidy(() => {
                const weights = tf.mean(grads, [0, 1]);
                const weightedActivations = convOutput.mul(weights);
                let heatmap = tf.sum(weightedActivations, -1);
                heatmap = heatmap.sub(tf.min(heatmap));
                heatmap = heatmap.div(tf.max(heatmap));
                return heatmap;
            });
            
            await drawHeatmapOnCanvas(heatmapTensor);
            heatmapStatus.textContent = "Isı Haritası hazır.";
            
            tf.dispose([imageTensor, heatmapTensor, convOutput, grads]);
        } catch (error) {
            heatmapStatus.textContent = `Hata: ${error.message}`;
            console.error("Heatmap Hatası:", error);
        }
    }
    
    // --- Olay Dinleyicileri ---
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.backgroundColor = 'rgba(255, 255, 255, 0.05)'; });
    dropZone.addEventListener('dragleave', (e) => { dropZone.style.backgroundColor = 'transparent'; });
    dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.style.backgroundColor = 'transparent'; handleFiles(e.dataTransfer.files); });
    tryAgainBtn.addEventListener('click', resetApp);
    
    // Heatmap Modal Olay Dinleyicileri
    closeHeatmapModalBtn.addEventListener('click', () => heatmapModal.classList.remove('visible'));
    heatmapModal.addEventListener('click', (e) => { if (e.target === heatmapModal) { heatmapModal.classList.remove('visible'); } });

    // --- Başlatma ---
    loadModel();
</script>
</body>
</html>


