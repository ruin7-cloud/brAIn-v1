<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>brAIn - v3</title>
    <base href="/">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <style>
        :root {
            --base-bg: #0D5D62; --base-text: #FFFFFF; --base-accent: #20C997; --base-card: rgba(255, 255, 255, 0.1); --base-border: rgba(255, 255, 255, 0.2);
            --bg-color: var(--base-bg); --card-color: var(--base-card); --primary-text: var(--base-text); --secondary-text: rgba(255, 255, 255, 0.7); --accent-color: var(--base-accent); --border-color: var(--base-border); --shadow-color: rgba(0, 0, 0, 0.2); --error-color: #FF5B5B; --success-color: #20C997; --warning-color: #FFC700; --outlier-color: #FFA500;
        }
        body.theme-patient {
            --bg-color: #08313A; --card-color: #0F4C5C; --primary-text: #E0FBFC; --secondary-text: #96C7C1; --accent-color: #20C997; --border-color: #1A7480;
        }
        body.theme-professional {
            --bg-color: #F0FFFF; --card-color: #FFFFFF; --primary-text: #08313A; --secondary-text: #5A7A7D; --accent-color: #0D5D62; --border-color: #D4E9E9; --shadow-color: rgba(0, 0, 0, 0.05);
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--primary-text); margin: 0; box-sizing: border-box; transition: background-color 0.5s ease; }
        .view { display: none; width: 100%; min-height: 100vh; position: absolute; top: 0; left: 0; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .view.active { display: flex; }
        #welcome-screen { flex-direction: column; }
        .welcome-title { font-size: 48px; font-weight: 700; color: var(--base-text); }
        .welcome-subtitle { font-size: 18px; color: var(--base-text); opacity: 0.8; margin-top: 8px; margin-bottom: 40px; max-width: 450px; text-align: center; }
        .role-selection { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
        .role-button { background-color: var(--base-card); border: 1px solid var(--base-border); border-radius: 16px; padding: 24px; width: 220px; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; backdrop-filter: blur(10px); text-align: center; }
        .role-button:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .role-button svg { color: var(--base-accent); margin-bottom: 16px; }
        .role-title { font-size: 18px; font-weight: 600; color: var(--base-text); }
        .role-description { font-size: 14px; color: var(--base-text); opacity: 0.7; margin-top: 8px; }
        #app-container { flex-direction: column; }
        .header { margin-bottom: 24px; text-align: center; position: relative; width: 100%; max-width: 480px; }
        .header h1 { font-size: 32px; font-weight: 700; margin: 0; }
        .header p { font-size: 16px; color: var(--secondary-text); margin: 4px 0 0 0; }
        #history-btn { position: absolute; top: 50%; left: 0; transform: translateY(-50%); background: none; border: none; color: var(--primary-text); cursor: pointer; padding: 10px; opacity: 0.8; transition: opacity 0.2s; }
        #history-btn:hover { opacity: 1; }
        .card { background-color: var(--card-color); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 24px; border: 1px solid var(--border-color); padding: 32px; width: 100%; max-width: 480px; transition: all 0.3s ease; box-shadow: 0 4px 10px var(--shadow-color); }
        .state { display: none; }
        .state.active { display: block; }
        .modal-overlay, #history-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 100; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.visible, #history-panel.visible { opacity: 1; visibility: visible; }
        .modal-overlay { display: flex; justify-content: center; align-items: center; }
        .login-card { background-color: var(--card-color); padding: 32px; border-radius: 16px; width: 300px; text-align: center; border: 1px solid var(--border-color); }
        .login-card h3 { margin-top: 0; color: var(--primary-text); }
        .login-card input { width: 100%; padding: 12px; margin-bottom: 16px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--primary-text); box-sizing: border-box; }
        .login-card #login-error { color: var(--error-color); min-height: 20px; font-size: 14px; }
        .btn { width: 100%; padding: 12px; font-size: 16px; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; transition: background-color 0.3s ease; }
        .btn-primary { background-color: var(--accent-color); color: var(--primary-text); }
        #history-panel { background: none; }
        .history-content { position: absolute; left: 0; top: 0; width: 320px; height: 100%; background-color: var(--bg-color); box-shadow: 5px 0 15px rgba(0,0,0,0.2); transform: translateX(-100%); transition: transform 0.3s ease; padding: 20px; box-sizing: border-box; }
        #history-panel.visible .history-content { transform: translateX(0); }
        .history-content h2 { margin-top: 0; }
        .history-list { list-style: none; padding: 0; }
        .history-item { background-color: var(--card-color); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s; }
        .history-item:hover { background-color: rgba(255,255,255,0.1); }
        .history-item .date { font-size: 12px; color: var(--secondary-text); }
        .history-item .summary { font-weight: 600; margin-top: 5px; }
        .patient-warning { padding: 15px; background-color: rgba(255,199,0,0.1); border: 1px solid var(--warning-color); color: var(--warning-color); border-radius: 8px; font-weight: 500; margin-top: 20px; }
        .prediction-list, .thumbnail-gallery, .results-title { text-align: left; }
    </style>
</head>
<body>

    <div id="welcome-screen" class="view">
        </div>

    <div id="app-container" class="view">
        <header class="header">
            <button id="history-btn" style="display: none;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 8V12L14 14M21.65 12.35C21.86 11.55 22 10.72 22 9.83C22 5.23 18.39 1.62 13.8 1.62C11.48 1.62 9.45 2.74 8.1 4.4L6.7 3H5V7H9L7.6 5.6C8.61 4.22 10.22 3.32 12 3.32C16.8 3.32 20.3 6.82 20.3 11.52C20.3 12.42 20.14 13.29 19.83 14.1L21.65 12.35Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <h1>brAIn</h1><p id="app-subtitle"></p>
        </header>
        <main class="card" id="main-card">
            </main>
    </div>

    <div id="login-modal" class="modal-overlay">
        </div>

    <div id="history-panel">
        <div class="history-content">
            <h2>Geçmiş Analizler</h2>
            <ul id="history-list" class="history-list">
                </ul>
        </div>
    </div>
    
<script>
// --- Değişkenler ve Sabitler ---
const CORRECT_PASSWORD = '1234';
let userRole, model, currentAnalysis;
const elements = { /* Tüm DOM elementleri burada toplanacak */ };

// --- Yönlendirme (Routing) ---
const routes = {
    '/': 'welcome-screen',
    '/patient': 'app-container',
    '/professional': 'app-container'
};

function router(path) {
    // ... (Önceki kodla aynı, sayfa geçişlerini yönetir)
}

// --- Uygulama Başlatma ve Rol Seçimi ---
function navigate(path) {
    history.pushState({ path }, '', path);
    router(path);
}

function initializeAppForRole(selectedRole) {
    userRole = selectedRole;
    document.body.className = ''; // Temaları temizle
    document.body.classList.add(userRole === 'patient' ? 'theme-patient' : 'theme-professional');
    
    // Uygulama arayüzünü yükle
    loadAppInterface();
    
    if (userRole === 'patient') {
        elements.historyBtn.style.display = 'block';
    }

    if (!model) {
        // loadModel();
        console.log("Model yüklemesi burada başlayacak.");
    }
}

// --- Arayüz Yükleyici ---
function loadAppInterface() {
    const mainCard = document.getElementById('main-card');
    mainCard.innerHTML = `
        <div id="default-state" class="state active">
            <h3 class="upload-title">MR Taramalarınızı Yükleyin</h3>
            <p class="upload-subtitle">Birden fazla dosya seçin veya sürükleyip bırakın</p>
            <div id="drop-zone" style="border:2px dashed var(--secondary-text); padding: 40px; margin-top: 20px; border-radius: 16px; cursor: pointer;">
                <p>Dosyaları Buraya Sürükleyin</p>
            </div>
        </div>
        <div id="uploading-state" class="state">
            <p>Analiz ediliyor, lütfen bekleyin...</p>
        </div>
        <div id="result-state" class="state">
            </div>`;
    // Gerekli olay dinleyicilerini buraya ekle (dropzone vs.)
}

// --- Hasta Geçmişi Fonksiyonları ---
function saveAnalysisToHistory(analysisData) {
    if (userRole !== 'patient') return;
    let history = JSON.parse(localStorage.getItem('brainHistory')) || [];
    history.unshift(analysisData); // En yeni başa gelsin
    if (history.length > 10) history.pop(); // Son 10 analizi sakla
    localStorage.setItem('brainHistory', JSON.stringify(history));
}

function renderHistory() {
    const historyList = document.getElementById('history-list');
    historyList.innerHTML = '';
    let history = JSON.parse(localStorage.getItem('brainHistory')) || [];
    if (history.length === 0) {
        historyList.innerHTML = '<p>Daha önce yapılmış analiz bulunamadı.</p>';
        return;
    }
    history.forEach(item => {
        const li = document.createElement('li');
        li.className = 'history-item';
        li.innerHTML = `<div class="date">${item.date}</div><div class="summary">${item.summary}</div>`;
        li.onclick = () => {
            // displayBatchResults(item.data.valid, item.data.invalid);
            console.log(`Geçmişten yükleniyor: ${item.id}`);
            document.getElementById('history-panel').classList.remove('visible');
        };
        historyList.appendChild(li);
    });
}

// --- Sonuçları Gösterme (Role Göre Farklılaşan) ---
function displayBatchResults(validResults, invalidResults) {
    const resultState = document.getElementById('result-state');
    let html = '';

    if(userRole === 'patient') {
        // HASTA GÖRÜNÜMÜ
        html += `<h3>Analiz Özeti</h3>`;
        // ... (Basitleştirilmiş sonuçlar, yüzdesiz, büyük uyarılar)
        html += `<div class="patient-warning"><strong>Önemli Uyarı:</strong> Bu sonuçlar tıbbi bir tanı değildir. Lütfen bulguları mutlaka bir sağlık profesyoneli ile görüşün.</div>`;
    } else {
        // PROFESYONEL GÖRÜNÜMÜ
        html += `<h3>Detaylı Analiz Sonuçları</h3>`;
        // ... (Tüm metrikler, yüzdeler, güven skoru, aykırı tespit)
    }

    resultState.innerHTML = html;

    // Analizi geçmişe kaydet
    const topPrediction = 'Sağlıklı'; // Örnek
    saveAnalysisToHistory({
        id: `res_${Date.now()}`,
        date: new Date().toLocaleString('tr-TR'),
        summary: `${validResults.length} Görüntü - En Yüksek Tahmin: ${topPrediction}`,
        data: { valid: validResults, invalid: invalidResults }
    });
}

// --- Başlangıç ve Olay Dinleyicileri ---
document.addEventListener("DOMContentLoaded", () => {
    // Tüm elementleri başta bir kere seç
    elements.welcomeScreen = document.getElementById('welcome-screen');
    elements.appContainer = document.getElementById('app-container');
    elements.rolePatientBtn = document.getElementById('role-patient');
    elements.roleProfessionalBtn = document.getElementById('role-professional');
    elements.loginModal = document.getElementById('login-modal');
    elements.passwordInput = document.getElementById('password-input');
    elements.loginBtn = document.getElementById('login-btn');
    elements.loginError = document.getElementById('login-error');
    elements.historyBtn = document.getElementById('history-btn');
    elements.historyPanel = document.getElementById('history-panel');

    // welcome-screen içeriğini oluştur (dinamik olması için)
    elements.welcomeScreen.innerHTML = `
        <h1 class="welcome-title">brAIn</h1>
        <p class="welcome-subtitle">Yapay zeka destekli MR görüntü analizi platformuna hoş geldiniz. Lütfen rolünüzü seçerek devam edin.</p>
        <div class="role-selection">
            <button class="role-button" data-path="/patient">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 12C13.6569 12 15 10.6569 15 9C15 7.34315 13.6569 6 12 6C10.3431 6 9 7.34315 9 9C9 10.6569 10.3431 12 12 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M19 21V19C19 16.7909 17.2091 15 15 15H9C6.79086 15 5 16.7909 5 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <h3 class="role-title">Hastayım / Yakınıyım</h3><p class="role-description">Basitleştirilmiş sonuçlar ve geçmiş takibi.</p>
            </button>
            <button class="role-button" data-path="/professional">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 13V9C22 8.44772 21.5523 8 21 8H17C16.4477 8 16 8.44772 16 9V13C16 13.5523 16.4477 14 17 14H21C21.5523 14 22 13.5523 22 13Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M13 19H10V11H13V19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 19H4V16H7V19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 8V5H5C3.89543 5 3 5.89543 3 7V19C3 20.1046 3.89543 21 5 21H16C17.1046 21 18 20.1046 18 19V16.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <h3 class="role-title">Sağlık Profesyoneliyim</h3><p class="role-description">Detaylı metrikler ve analiz araçları.</p>
            </button>
        </div>`;
    // login-modal içeriğini oluştur
    elements.loginModal.innerHTML = `
        <div class="login-card">
            <h3>Profesyonel Girişi</h3>
            <input type="password" id="password-input-inner" placeholder="Şifre">
            <p id="login-error"></p>
            <button id="login-btn-inner" class="btn btn-primary">Giriş Yap</button>
        </div>`;

    document.querySelector('.role-button[data-path="/patient"]').addEventListener('click', (e) => navigate(e.currentTarget.dataset.path));
    document.querySelector('.role-button[data-path="/professional"]').addEventListener('click', () => {
        document.body.classList.add('theme-professional');
        elements.loginModal.classList.add('visible');
    });

    document.getElementById('login-btn-inner').addEventListener('click', () => {
        const pass = document.getElementById('password-input-inner').value;
        if (pass === CORRECT_PASSWORD) {
            elements.loginModal.classList.remove('visible');
            navigate('/professional');
        } else {
            document.getElementById('login-error').textContent = 'Hatalı şifre.';
        }
    });
    
    elements.historyBtn.addEventListener('click', () => {
        renderHistory();
        elements.historyPanel.classList.add('visible');
    });

    elements.historyPanel.addEventListener('click', (e) => {
        if (e.target === elements.historyPanel) {
            elements.historyPanel.classList.remove('visible');
        }
    });

    window.addEventListener('popstate', () => router(window.location.pathname));
    router(window.location.pathname);
});
</script>
</body>
</html>
