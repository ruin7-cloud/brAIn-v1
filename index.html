<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>brAIn - v2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <style>
        :root {
            --bg-color: #121829;
            --card-color: rgba(38, 45, 69, 0.7);
            --primary-text: #FFFFFF;
            --secondary-text: #A1A8B8;
            --accent-color: #4A4DE6;
            --error-color: #FF5B5B;
            --success-color: #00C48C;
            --warning-color: #FFC700;
            --outlier-color: #FFA500;
            --border-color: rgba(255, 255, 255, 0.1);
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--primary-text); margin: 0; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; text-align: center; }
        .top-bar { position: fixed; top: 20px; right: 20px; z-index: 10; display: flex; align-items: center; gap: 15px; }
        .lang-switcher { display: flex; align-items: center; background-color: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 8px; }
        .lang-link { color: var(--secondary-text); text-decoration: none; font-weight: 600; font-size: 14px; margin: 0 5px; transition: color 0.3s; }
        .lang-link.active, .lang-link:hover { color: var(--primary-text); }
        #about-btn { background: none; border: none; cursor: pointer; color: var(--secondary-text); padding: 0; transition: color 0.3s; }
        #about-btn:hover { color: var(--primary-text); }
        .header { margin-bottom: 24px; }
        .header h1 { font-size: 32px; font-weight: 700; margin: 0; }
        .header p { font-size: 16px; color: var(--secondary-text); margin: 4px 0 0 0; }
        .card { background: var(--card-color); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 24px; border: 1px solid var(--border-color); padding: 32px; width: 100%; max-width: 480px; transition: all 0.3s ease; }
        .state { display: none; }
        .state.active { display: block; }
        .disclaimer { font-size: 12px; color: var(--warning-color); background-color: rgba(255, 199, 0, 0.1); border: 1px solid rgba(255, 199, 0, 0.2); border-radius: 8px; padding: 10px; margin-top: 24px; text-align: left; line-height: 1.5; }
        .upload-title { font-size: 18px; font-weight: 600; margin: 0; }
        .upload-subtitle { font-size: 14px; color: var(--secondary-text); margin-top: 4px; }
        .upload-options { display: flex; gap: 12px; margin-top: 24px; }
        .upload-options > * { flex: 1; }
        #drop-zone { border: 2px dashed var(--secondary-text); border-radius: 16px; padding: 20px; cursor: pointer; transition: background-color 0.3s ease; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; box-sizing: border-box; }
        #drop-zone:hover { background-color: rgba(255, 255, 255, 0.05); }
        #drop-zone svg { color: var(--accent-color); margin-bottom: 8px; }
        #drop-zone span { font-size: 14px; font-weight: 500; }
        input[type="file"] { display: none; }
        .btn { width: 100%; padding: 12px; font-size: 16px; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; transition: background-color 0.3s ease; display: flex; justify-content: center; align-items: center; gap: 8px; line-height: 1; }
        .btn:disabled { background-color: #555; cursor: not-allowed; }
        .btn-primary { background-color: var(--accent-color); color: var(--primary-text); }
        .btn-primary:hover:not(:disabled) { background-color: #3a3dc5; }
        .btn-secondary { background-color: rgba(0,0,0,0.2); color: var(--primary-text); }
        .btn-secondary:hover:not(:disabled) { background-color: rgba(0,0,0,0.4); }
        .btn svg { flex-shrink: 0; }
        .file-info-card { background-color: rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 12px; text-align: left; }
        .file-icon { flex-shrink: 0; padding: 8px; background-color: var(--accent-color); border-radius: 8px; }
        .file-details { overflow: hidden; }
        .file-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-status { font-size: 14px; color: var(--secondary-text); }
        .progress-bar-container { width: 100%; height: 6px; background-color: rgba(0, 0, 0, 0.3); border-radius: 3px; margin-top: 12px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background-color: var(--accent-color); border-radius: 3px; transition: width 0.5s ease; }
        #error-state .file-icon { background-color: var(--error-color); }
        #result-state { padding: 24px; }
        #result-content { }
        .results-title { font-size: 20px; font-weight: 600; margin-bottom: 16px; text-align: left; }
        .prediction-list { display: flex; flex-direction: column; gap: 12px; text-align: left; }
        .prediction-item { display: flex; align-items: center; gap: 12px; }
        .prediction-label { flex-basis: 120px; flex-shrink: 0; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .prediction-bar-bg { flex-grow: 1; height: 24px; background-color: rgba(0, 0, 0, 0.3); border-radius: 6px; overflow: hidden; }
        .prediction-bar { width: 0; height: 100%; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; box-sizing: border-box; font-size: 12px; font-weight: 600; color: var(--primary-text); transition: width 0.4s ease-in-out; }
        .prediction-item .prediction-bar { background-color: var(--accent-color); }
        .prediction-item.top-prediction .prediction-bar { background-color: var(--success-color); }
        .tumor-info { border-top: 1px solid var(--border-color); margin-top: 20px; padding-top: 20px; text-align: left; }
        .tumor-info h4 { margin: 0 0 8px 0; color: var(--success-color); display: flex; align-items: center; gap: 8px; }
        .tumor-info h4 a { color: var(--secondary-text); transition: color 0.3s; }
        .tumor-info h4 a:hover { color: var(--primary-text); }
        .tumor-info p { margin: 0; font-size: 14px; line-height: 1.6; color: var(--secondary-text); }
        .result-buttons { display: flex; gap: 12px; margin-top: 24px; }
        .detailed-results { border-top: 1px solid var(--border-color); margin-top: 20px; padding-top: 20px;}
        .thumbnail-gallery { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
        .thumbnail { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; cursor: pointer; border: 2px solid transparent; transition: all 0.3s; opacity: 0.7; }
        .thumbnail:hover { opacity: 1; }
        .thumbnail.active { border-color: var(--accent-color); opacity: 1; }
        .thumbnail.outlier { border-color: var(--outlier-color); }
        #camera-feed { width: 100%; max-width: 400px; border-radius: 16px; margin-bottom: 16px;}
        .confidence-score { text-align: left; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .confidence-score strong { font-size: 16px; }
        .confidence-score span { font-size: 18px; font-weight: 700; color: var(--success-color); }
        .invalid-images { margin-top: 20px; }
        .invalid-images p { font-size: 14px; color: var(--warning-color); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 100; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: var(--card-color); padding: 30px; border-radius: 16px; max-width: 500px; width: 90%; text-align: left; }
        .modal-content h2 { margin-top: 0; }
        .modal-content p { color: var(--secondary-text); }
        .modal-content ul { padding-left: 20px; color: var(--secondary-text); }
        .modal-content a { color: var(--accent-color); }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="lang-switcher">
            <a href="#" class="lang-link" data-lang="en">EN</a>
            <span>|</span>
            <a href="#" class="lang-link" data-lang="tr">TR</a>
        </div>
        <button id="about-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 15c-.55 0-1-.45-1-1v-4c0-.55.45-1 1-1s1 .45 1 1v4c0 .55-.45 1-1 1zm1-8h-2V7h2v2z"/></svg>
        </button>
    </div>
    
    <div id="about-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 data-key="aboutTitle">About this Project</h2>
            <p data-key="aboutDesc1">This tool is an AI-powered brain tumor classifier designed as a proof-of-concept. It utilizes a deep learning model to analyze brain MRI scans and predict one of seven categories, including several tumor types and healthy scans.</p>
            <p><strong data-key="techUsed">Technologies Used:</strong></p>
            <ul>
                <li><strong>TensorFlow.js:</strong> For running the machine learning model directly in the browser.</li>
                <li><strong>Teachable Machine:</strong> For training the custom image classification model.</li>
                <li><strong>Google AI:</strong> Powered by Google's advanced AI research and infrastructure.</li>
            </ul>
            <p><strong data-key="developer">Developer:</strong> <span data-key="yourName">Isa Sahin</span></p>
            <p style="font-size: 12px; color: var(--warning-color);" data-key="aboutDisclaimer"><strong>Important:</strong> This tool is for educational and research purposes only and is not a substitute for professional medical advice.</p>
            <button id="close-modal-btn" class="btn btn-primary" style="margin-top: 20px;" data-key="btnClose">Close</button>
        </div>
    </div>

    <header class="header"><h1>brAIn</h1><p data-key="headerSubtitle">Tumor Classifier</p></header>
    <main class="card" id="main-card">
        <div id="default-state" class="state active">
            <h3 class="upload-title" data-key="uploadTitle">Upload your MRI Scans</h3>
            <p class="upload-subtitle" data-key="uploadSubtitle">Select multiple files or use your camera</p>
            <div class="upload-options">
                <label for="file-input" id="drop-zone">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M14.4,6.1H16.8V8.5H19.2V6.1H21.6V3.7H19.2V1.3H16.8V3.7H14.4V6.1ZM12,18A4.8,4.8,0,1,0,7.2,13.2,4.8,4.8,0,0,0,12,18Zm0-7.2a2.4,2.4,0,1,1-2.4,2.4A2.4,2.4,0,0,1,12,10.8ZM18,3.7H14.46A7.14,7.14,0,0,0,12,2.5,7.14,7.14,0,0,0,9.54,3.7H6A3.6,3.6,0,0,0,2.4,7.3V19.3A3.6,3.6,0,0,0,6,22.9H18a3.6,3.6,0,0,0,3.6-3.6V7.3A3.6,3.6,0,0,0,18,3.7Zm1.2,15.6a1.2,1.2,0,0,1-1.2,1.2H6a1.2,1.2,0,0,1-1.2-1.2V7.3A1.2,1.2,0,0,1,6,6.1H18a1.2,1.2,0,0,1,1.2,1.2Z"/></svg>
                    <span data-key="btnChooseFiles">Choose Files</span>
                </label>
                <button id="camera-btn" class="btn btn-secondary">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M20 4h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 11.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 6.5 12 6.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5z"/></svg>
                    <span data-key="btnUseCamera">Use Camera</span>
                </button>
            </div>
            <div class="disclaimer">
                <strong data-key="disclaimerTitle">WARNING:</strong> <span data-key="disclaimerText">This project is under development...</span>
            </div>
            <input type="file" id="file-input" accept="image/*" multiple>
        </div>
        <div id="uploading-state" class="state">
             <div class="file-info-card">
                <div class="file-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/></svg></div>
                <div class="file-details"><div id="file-name" class="file-name"></div><div id="file-status" class="file-status"></div></div>
            </div>
            <div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div>
        </div>
        <div id="error-state" class="state">
            <div class="file-info-card">
                <div class="file-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg></div>
                <div class="file-details"><div class="file-name" data-key="errorTitle">Error</div><div class="file-status" data-key="errorText">Please upload valid image files.</div></div>
            </div>
            <button id="try-again-btn" class="btn btn-primary" data-key="btnTryAgain">Try again</button>
        </div>
        <div id="result-state" class="state">
            <div id="result-content">
                <div id="confidence-score" class="confidence-score"></div>
                <h3 id="main-results-title" class="results-title"></h3>
                <div id="prediction-list" class="prediction-list"></div>
                <div id="tumor-info" class="tumor-info"></div>
                <div id="detailed-results" class="detailed-results">
                    <h3 class="results-title" style="font-size: 18px;" data-key="detailedBreakdown"></h3>
                    <div id="thumbnail-gallery" class="thumbnail-gallery"></div>
                </div>
                <div id="invalid-images" class="invalid-images" style="display: none;">
                    <h3 class="results-title" style="font-size: 16px; color: var(--warning-color);" data-key="invalidImagesTitle"></h3>
                    <div id="invalid-thumbnail-gallery" class="thumbnail-gallery"></div>
                </div>
            </div>
            <div class="result-buttons">
                <button id="pdf-btn" class="btn btn-secondary"><span data-key="btnDownloadReport">Download Report</span></button>
                <button id="scan-another-btn" class="btn btn-primary"><span data-key="btnScanAnother">Scan Another</span></button>
            </div>
        </div>
        <div id="camera-state" class="state">
            <video id="camera-feed" autoplay playsinline></video>
            <div class="result-buttons">
                <button id="cancel-camera-btn" class="btn btn-secondary" data-key="btnCancel">Cancel</button>
                <button id="capture-btn" class="btn btn-primary" data-key="btnCaptureImage">Capture Image</button>
            </div>
        </div>
    </main>
    <script>
        const { jsPDF } = window.jspdf;
        const URL = "./model/";
        const CONFIDENCE_THRESHOLD = 0.50; // 50%
        let model, webcamStream, currentResultId, currentLang;
        let batchResults = [], invalidImages = [];

        const translations = {
            en: {
                headerSubtitle: "Tumor Classifier", uploadTitle: "Upload your MRI Scans", uploadSubtitle: "Select multiple files or use your camera", btnChooseFiles: "Choose Files", btnUseCamera: "Use Camera", disclaimerTitle: "WARNING:", disclaimerText: "This project is under development. The results may not be 100% accurate and should absolutely not be used for medical diagnosis or treatment.", errorTitle: "Error", errorText: "Please upload valid image files.", btnTryAgain: "Try Again", avgResultTitle: "Average Result", detailedBreakdown: "Detailed Breakdown", resultForImage: "Result for: Image", noConfidentResult: "No confident prediction could be made.", btnDownloadReport: "Download Report", btnScanAnother: "Scan Another", btnCancel: "Cancel", btnCaptureImage: "Capture Image", analyzingText: "Analyzing", ofText: "of", fromCameraText: "from Camera", creatingPdf: "Creating PDF...", pdfReportTitle: "brAIn Analysis Report", pdfReportDate: "Report Date", pdfAnalysisId: "Analysis ID", pdfAvgResult: "Average Result", pdfDetailedBreakdown: "Detailed Breakdown", pdfImage: "Image", confidenceScore: "Overall Confidence Score", invalidImagesTitle: "Unsuitable for Analysis", invalidImagesText: "The following images were not recognized as brain MRIs and were excluded from the average result.", aboutTitle: "About this Project", aboutDesc1: "This tool is an AI-powered brain tumor classifier designed as a proof-of-concept. It utilizes a deep learning model to analyze brain MRI scans and predict one of seven categories, including several tumor types and healthy scans.", techUsed: "Technologies Used:", developer: "Developer:", yourName: "Isa Sahin", aboutDisclaimer: "Important: This tool is for educational and research purposes only and is not a substitute for professional medical advice.", btnClose: "Close",
                methodologyText: "This report was generated using a deep learning model (TensorFlow.js & Teachable Machine) trained on over 4,000 brain MRI scans across 7 distinct classifications. The results indicate the model's prediction based on the provided images and should not be considered a definitive medical diagnosis.",
                tumorDescriptions: { "GBM": { name: "Glioblastoma Multiforme (GBM)", link: "https://en.wikipedia.org/wiki/Glioblastoma", description: "One of the most aggressive brain tumors..." }, "Menengiom": { name: "Meningioma", link: "https://en.wikipedia.org/wiki/Meningioma", description: "A generally slow-growing and benign tumor..." }, "Oligodendrogliom": { name: "Oligodendroglioma", link: "https://en.wikipedia.org/wiki/Oligodendroglioma", description: "A type of tumor that develops from oligodendrocytes..." }, "Pituitary": { name: "Pituitary Tumor", link: "https://en.wikipedia.org/wiki/Pituitary_adenoma", description: "A usually benign tumor that develops in the pituitary gland..." }, "CVM": { name: "Cerebral Vascular Malformation (CVM)", link: "https://en.wikipedia.org/wiki/Vascular_malformation", description: "A congenital blood vessel abnormality..." }, "AVM": { name: "Arteriovenous Malformation (AVM)", link: "https://en.wikipedia.org/wiki/Arteriovenous_malformation", description: "An abnormal connection between arteries and veins..." }, "Healthy": { name: "Healthy", link: "", description: "No tumor or significant anomaly was detected..." } }
            },
            tr: {
                headerSubtitle: "Tümör Sınıflandırıcı", uploadTitle: "MR Taramalarınızı Yükleyin", uploadSubtitle: "Birden fazla dosya seçin veya kameranızı kullanın", btnChooseFiles: "Dosya Seç", btnUseCamera: "Kamera Kullan", disclaimerTitle: "UYARI:", disclaimerText: "Bu proje geliştirme aşamasındadır. Sonuçlar %100 doğruluk sunmayabilir ve kesinlikle tıbbi tanı veya tedavi amacıyla kullanılamaz.", errorTitle: "Hata", errorText: "Lütfen geçerli resim dosyaları yükleyin.", btnTryAgain: "Tekrar Dene", avgResultTitle: "Ortalama Sonuç", detailedBreakdown: "Detaylı Döküm", resultForImage: "Sonuç: Görüntü", noConfidentResult: "Yeterli kesinlikte bir sonuç bulunamadı.", btnDownloadReport: "Raporu İndir", btnScanAnother: "Başkasına Tara", btnCancel: "İptal", btnCaptureImage: "Fotoğraf Çek", analyzingText: "Analiz ediliyor", ofText: "/", fromCameraText: "Kameradan", creatingPdf: "PDF Oluşturuluyor...", pdfReportTitle: "brAIn Analiz Raporu", pdfReportDate: "Rapor Tarihi", pdfAnalysisId: "Analiz ID", pdfAvgResult: "Ortalama Sonuç", pdfDetailedBreakdown: "Detaylı Döküm", pdfImage: "Görüntü", confidenceScore: "Genel Güven Skoru", invalidImagesTitle: "Analiz İçin Uygun Değil", invalidImagesText: "Aşağıdaki görüntüler beyin MR'ı olarak algılanamadı ve ortalama sonuca dahil edilmedi.", aboutTitle: "Proje Hakkında", aboutDesc1: "Bu araç, konsept kanıtlama amacıyla tasarlanmış yapay zeka destekli bir beyin tümörü sınıflandırıcısıdır. Beyin MR'larını analiz etmek ve çeşitli tümör türleri ile sağlıklı taramalar dahil olmak üzere yedi kategoriden birini tahmin etmek için bir derin öğrenme modeli kullanır.", techUsed: "Kullanılan Teknolojiler:", developer: "Geliştirici:", yourName: "Isa Sahin", aboutDisclaimer: "Önemli: Bu araç yalnızca eğitim ve araştırma amaçlıdır ve profesyonel tıbbi tavsiye yerine geçmez.", btnClose: "Kapat",
                methodologyText: "Bu rapor, 7 farklı sınıf üzerinde 4000'den fazla beyin MR görüntüsü ile eğitilmiş bir derin öğrenme modeli (TensorFlow.js & Teachable Machine) kullanılarak oluşturulmuştur. Sonuçlar, sağlanan görüntülere dayanarak modelin tahminini belirtir ve kesin bir tıbbi tanı olarak kabul edilmemelidir.",
                tumorDescriptions: { "GBM": { name: "Glioblastoma Multiforme (GBM)", link: "https://tr.wikipedia.org/wiki/Glioblastoma", description: "En agresif beyin tümörlerinden biridir..." }, "Menengiom": { name: "Menenjiyom", link: "https://tr.wikipedia.org/wiki/Menenjiyom", description: "Genellikle yavaş büyüyen ve iyi huylu bir tümördür..." }, "Oligodendrogliom": { name: "Oligodendrogliom", link: "https://tr.wikipedia.org/wiki/Oligodendrogliom", description: "Oligodendrosit hücrelerinden gelişen bir tümör türüdür..." }, "Pituitary": { name: "Hipofiz Tümörü (Pituitary)", link: "https://tr.wikipedia.org/wiki/Hipofiz_adenomu", description: "Hipofiz bezinde gelişen, genellikle iyi huylu bir tümördür..." }, "CVM": { name: "Serebral Vasküler Malformasyon (CVM)", link: "https://tr.wikipedia.org/wiki/Vask%C3%BCler_malformasyon", description: "Doğuştan gelen bir kan damarı anomalisidir..." }, "AVM": { name: "Arteriovenöz Malformasyon (AVM)", link: "https://tr.wikipedia.org/wiki/Arteriyoven%C3%B6z_malformasyon", description: "Atardamarlar ve toplardamarlar arasında anormal bir bağlantıdır..." }, "Healthy": { name: "Sağlıklı (Healthy)", link: "", description: "Analiz edilen MR görüntüsünde herhangi bir tümör veya belirgin bir anomali tespit edilmemiştir..." } }
            }
        };

        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const cameraBtn = document.getElementById('camera-btn');
        const captureBtn = document.getElementById('capture-btn');
        const cancelCameraBtn = document.getElementById('cancel-camera-btn');
        const pdfBtn = document.getElementById('pdf-btn');
        const scanAnotherBtn = document.getElementById('scan-another-btn');
        const tryAgainBtn = document.getElementById('try-again-btn');
        const cameraFeed = document.getElementById('camera-feed');
        const aboutBtn = document.getElementById('about-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const aboutModal = document.getElementById('about-modal');
        const states = { default: document.getElementById('default-state'), uploading: document.getElementById('uploading-state'), error: document.getElementById('error-state'), result: document.getElementById('result-state'), camera: document.getElementById('camera-state'), };
        const fileNameEl = document.getElementById('file-name');
        const fileStatusEl = document.getElementById('file-status');
        const progressBar = document.getElementById('progress-bar');
        const predictionList = document.getElementById('prediction-list');
        const tumorInfoEl = document.getElementById('tumor-info');
        const thumbnailGallery = document.getElementById('thumbnail-gallery');
        const mainResultsTitle = document.getElementById('main-results-title');
        const confidenceScoreEl = document.getElementById('confidence-score');
        const invalidImagesEl = document.getElementById('invalid-images');
        const invalidThumbnailGallery = document.getElementById('invalid-thumbnail-gallery');

        function changeLanguage(lang) { if (!translations[lang]) return; currentLang = lang; localStorage.setItem('brain-lang', lang); document.documentElement.lang = lang; document.querySelectorAll('[data-key]').forEach(el => { const key = el.dataset.key; if (translations[lang][key]) { el.textContent = translations[lang][key]; }}); document.querySelectorAll('.lang-link').forEach(link => { link.classList.toggle('active', link.dataset.lang === lang); }); if (states.result.classList.contains('active')) { displayBatchResults(); } }
        function showState(stateName) { Object.values(states).forEach(s => s.classList.remove('active')); states[stateName]?.classList.add('active'); }
        async function loadModel() { try { model = await tmImage.load(URL + "model.json", URL + "metadata.json"); } catch (error) { console.error("Model yüklenemedi:", error); const errEl = document.querySelector('[data-key="disclaimerText"]'); if(errEl) errEl.textContent = 'ERROR: The model could not be loaded. Please check your internet connection and refresh the page.'; } }
        
        function renderPredictionUI(predictions, title) {
            mainResultsTitle.textContent = title;
            predictionList.innerHTML = '';
            const filtered = predictions.filter(p => p.probability >= 0.1).sort((a, b) => b.probability - a.probability);
            if (filtered.length === 0) { predictionList.innerHTML = `<p>${translations[currentLang].noConfidentResult}</p>`; return null; }
            
            const topPrediction = filtered[0];
            filtered.forEach((p, index) => {
                const item = document.createElement('div');
                item.className = 'prediction-item ' + (index === 0 ? 'top-prediction' : '');
                const percentage = p.probability.toFixed(1);
                const className = translations[currentLang].tumorDescriptions[p.className]?.name.split(' (')[0] || p.className;
                item.innerHTML = `<div class="prediction-label" title="${className}">${className}</div><div class="prediction-bar-bg"><div class="prediction-bar">${percentage}%</div></div>`;
                predictionList.appendChild(item);
                setTimeout(() => { item.querySelector('.prediction-bar').style.width = `${percentage}%`; }, 50);
            });
            return topPrediction;
        }

        function displayBatchResults() {
            if (batchResults.length === 0 && invalidImages.length > 0) {
                 showState('result'); mainResultsTitle.textContent = translations[currentLang].avgResultTitle; predictionList.innerHTML = `<p>${translations[currentLang].noConfidentResult}</p>`; confidenceScoreEl.innerHTML = ''; tumorInfoEl.style.display = 'none'; document.getElementById('detailed-results').style.display = 'none';
            } else if (batchResults.length > 0) {
                const classTotals = {};
                model.getClassLabels().forEach(label => { classTotals[label] = 0; });
                batchResults.forEach(result => { result.predictions.forEach(p => { classTotals[p.className] += p.probability; }); });
                const averagePredictions = Object.entries(classTotals).map(([className, total]) => ({ className, probability: (total / batchResults.length) * 100 }));
                
                const topAvgPrediction = renderPredictionUI(averagePredictions, translations[currentLang].avgResultTitle);
                updateTumorInfo(topAvgPrediction);
                
                const { overallScore, majorityClass } = calculateConfidence();
                confidenceScoreEl.innerHTML = `<strong data-key="confidenceScore">${translations[currentLang].confidenceScore}:</strong> <span>${overallScore.toFixed(1)}%</span>`;

                thumbnailGallery.innerHTML = '';
                const detailedResultsEl = document.getElementById('detailed-results');
                if (batchResults.length > 1) {
                    detailedResultsEl.style.display = 'block';
                    batchResults.forEach((result, index) => {
                        const thumb = document.createElement('img');
                        thumb.src = result.imageSrc;
                        thumb.className = 'thumbnail';
                        const resultTopClass = result.predictions.sort((a,b) => b.probability - a.probability)[0].className;
                        if (resultTopClass !== majorityClass) { thumb.classList.add('outlier'); }
                        if (index === 0) thumb.classList.add('active');
                        thumb.onclick = () => {
                            document.querySelectorAll('.thumbnail.active').forEach(t => t.classList.remove('active'));
                            thumb.classList.add('active');
                            const individualPredictions = result.predictions.map(p => ({...p, probability: p.probability * 100}));
                            const topIndividual = renderPredictionUI(individualPredictions, `${translations[currentLang].resultForImage} ${index + 1}`);
                            updateTumorInfo(topIndividual);
                        };
                        thumbnailGallery.appendChild(thumb);
                    });
                } else {
                    detailedResultsEl.style.display = 'none';
                }
            }
            
            invalidThumbnailGallery.innerHTML = '';
            if(invalidImages.length > 0) {
                invalidImagesEl.style.display = 'block';
                invalidImagesEl.querySelector('h3').textContent = translations[currentLang].invalidImagesTitle;
                invalidImages.forEach(imgSrc => { const thumb = document.createElement('img'); thumb.src = imgSrc; thumb.className = 'thumbnail'; invalidThumbnailGallery.appendChild(thumb); });
            } else {
                invalidImagesEl.style.display = 'none';
            }

            if (!currentResultId) { currentResultId = `res_${Date.now()}`; try { const dataToStore = { valid: batchResults, invalid: invalidImages }; sessionStorage.setItem(currentResultId, JSON.stringify(dataToStore)); } catch(e) { console.error("Session storage error:", e); } }
            showState('result');
        }

        function calculateConfidence() { if (batchResults.length === 0) return { overallScore: 0, majorityClass: null }; const topPredictions = batchResults.map(r => r.predictions.sort((a, b) => b.probability - a.probability)[0]); const classCounts = topPredictions.reduce((acc, pred) => { acc[pred.className] = (acc[pred.className] || 0) + 1; return acc; }, {}); const majorityClass = Object.keys(classCounts).reduce((a, b) => classCounts[a] > classCounts[b] ? a : b); const consistency = (classCounts[majorityClass] / batchResults.length) * 100; const avgCertainty = topPredictions.reduce((sum, pred) => sum + pred.probability, 0) / topPredictions.length * 100; const overallScore = (consistency * 0.6) + (avgCertainty * 0.4); return { overallScore, majorityClass }; }
        function updateTumorInfo(topPrediction) { const info = topPrediction ? translations[currentLang].tumorDescriptions[topPrediction.className] : null; if (info) { const learnMoreLink = info.link ? `<a href="${info.link}" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg></a>` : ''; tumorInfoEl.innerHTML = `<h4>${info.name} ${learnMoreLink}</h4><p>${info.description}</p>`; tumorInfoEl.style.display = 'block'; } else { tumorInfoEl.style.display = 'none'; } }

        async function runBatchAnalysis(files) {
            batchResults = []; invalidImages = []; currentResultId = null; showState('uploading');
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                fileNameEl.textContent = `${translations[currentLang].analyzingText} ${i + 1} ${translations[currentLang].ofText} ${files.length}`;
                fileStatusEl.textContent = file.name;
                progressBar.style.width = `${((i + 1) / files.length) * 100}%`;
                const imageSrc = await new Promise(resolve => { const reader = new FileReader(); reader.onload = e => resolve(e.target.result); reader.readAsDataURL(file); });
                const img = await new Promise(resolve => { const image = new Image(); image.src = imageSrc; image.onload = () => resolve(image); });
                const predictions = await model.predict(img);
                const topPred = predictions.sort((a,b) => b.probability - a.probability)[0];
                if(topPred.probability >= CONFIDENCE_THRESHOLD){ batchResults.push({ imageSrc, predictions }); } else { invalidImages.push(imageSrc); }
            }
            displayBatchResults();
        }

        function handleFiles(files) { if (!files || files.length === 0) { showState('error'); return; } const imageFiles = Array.from(files).filter(f => f.type.startsWith("image/")); if (imageFiles.length === 0) { showState('error'); return; } runBatchAnalysis(imageFiles); }
        async function handleCameraCapture() { const canvas = document.createElement('canvas'); canvas.width = cameraFeed.videoWidth; canvas.height = cameraFeed.videoHeight; canvas.getContext('2d').drawImage(cameraFeed, 0, 0, canvas.width, canvas.height); stopCamera(); const imageSrc = canvas.toDataURL('image/png'); const img = await new Promise(resolve => { const image = new Image(); image.src = imageSrc; image.onload = () => resolve(image); }); const predictions = await model.predict(img); batchResults = [{ imageSrc, predictions }]; invalidImages = []; currentResultId = null; displayBatchResults(); }
        async function startCamera() { showState('camera'); try { webcamStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }); cameraFeed.srcObject = webcamStream; } catch (e) { console.error("Kamera erişimi hatası:", e); resetApp(); } }
        function stopCamera() { if (webcamStream) { webcamStream.getTracks().forEach(track => track.stop()); } }
        function resetApp() { stopCamera(); fileInput.value = ''; showState('default'); }

        async function generatePDF() {
            const btn = document.getElementById('pdf-btn');
            btn.disabled = true;
            btn.querySelector('span').textContent = translations[currentLang].creatingPdf;

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: 'a4' });
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 40;
            let yPos = margin;

            pdf.setFontSize(24).setFont('helvetica', 'bold'); pdf.text(translations[currentLang].pdfReportTitle, margin, yPos);
            yPos += 20;
            pdf.setFontSize(10).setFont('helvetica', 'normal');
            const dateStr = new Date().toLocaleString(currentLang === 'tr' ? 'tr-TR' : 'en-US');
            pdf.text(`${translations[currentLang].pdfReportDate}: ${dateStr}`, margin, yPos);
            pdf.text(`${translations[currentLang].pdfAnalysisId}: ${currentResultId}`, pageWidth - margin, yPos, { align: 'right' });
            yPos += 10;
            pdf.setDrawColor('#cccccc').line(margin, yPos, pageWidth - margin, yPos);
            yPos += 20;

            pdf.setFontSize(10).setFont('helvetica', 'bold');
            pdf.text('Methodology:', margin, yPos);
            yPos += 12;
            pdf.setFontSize(8).setFont('helvetica', 'normal');
            const methodologyLines = pdf.splitTextToSize(translations[currentLang].methodologyText, pageWidth - margin * 2);
            pdf.text(methodologyLines, margin, yPos);
            yPos += methodologyLines.length * 10 + 10;

            const { overallScore } = calculateConfidence();
            pdf.setFontSize(12).setFont('helvetica', 'bold');
            pdf.text(`${translations[currentLang].confidenceScore}: ${overallScore.toFixed(1)}%`, margin, yPos);
            yPos += 20;

            pdf.setFontSize(16).setFont('helvetica', 'bold');
            pdf.text(translations[currentLang].pdfAvgResult, margin, yPos);
            yPos += 15;

            const classTotals = {};
            model.getClassLabels().forEach(label => { classTotals[label] = 0; });
            batchResults.forEach(result => { result.predictions.forEach(p => { classTotals[p.className] += p.probability; }); });
            const averagePredictions = Object.entries(classTotals).map(([className, total]) => ({ className, probability: (total / batchResults.length) * 100 })).filter(p => p.probability >= 1).sort((a,b) => b.probability - a.probability);

            const barHeight = 14;
            const barYMargin = 6;
            const barStartX = margin + 100;
            const barMaxWidth = pageWidth - barStartX - margin;
            
            averagePredictions.forEach((p, index) => {
                const className = translations[currentLang].tumorDescriptions[p.className]?.name.split(' (')[0] || p.className;
                const percentage = p.probability.toFixed(1);
                pdf.setFontSize(8).setFont('helvetica', 'normal');
                pdf.text(className, margin, yPos + barHeight / 1.5);
                pdf.setFillColor(238, 238, 238);
                pdf.rect(barStartX, yPos, barMaxWidth, barHeight, 'F');
                pdf.setFillColor(index === 0 ? 0, 196, 140 : 74, 77, 230);
                pdf.rect(barStartX, yPos, barMaxWidth * (p.probability / 100), barHeight, 'F');
                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(8).setFont('helvetica', 'bold');
                pdf.text(`${percentage}%`, barStartX + barMaxWidth - 5, yPos + barHeight / 1.5, { align: 'right'});
                pdf.setTextColor(0, 0, 0);
                yPos += barHeight + barYMargin;
            });
            yPos += 10;
            
            if (batchResults.length > 1) {
                if (yPos > pageHeight - 80) { pdf.addPage(); yPos = margin; }
                pdf.setFontSize(16).setFont('helvetica', 'bold'); pdf.text(translations[currentLang].pdfDetailedBreakdown, margin, yPos); yPos += 15;
                const thumbSize = 60;
                for (let i = 0; i < batchResults.length; i++) {
                    const result = batchResults[i];
                    if (yPos + thumbSize + 10 > pageHeight - margin) { pdf.addPage(); yPos = margin; }
                    pdf.addImage(result.imageSrc, 'PNG', margin, yPos, thumbSize, thumbSize);
                    let textX = margin + thumbSize + 10;
                    pdf.setFontSize(10).setFont('helvetica', 'bold'); pdf.text(`${translations[currentLang].pdfImage} ${i + 1}`, textX, yPos + 10);
                    const sortedPreds = [...result.predictions].sort((a,b) => b.probability - a.probability);
                    let predY = yPos + 22;
                    for(let j = 0; j < Math.min(sortedPreds.length, 3); j++) {
                        const p = sortedPreds[j];
                        const className = translations[currentLang].tumorDescriptions[p.className]?.name.split(' (')[0] || p.className;
                        pdf.setFontSize(8).setFont('helvetica', 'normal'); pdf.text(`${className}: ${(p.probability * 100).toFixed(1)}%`, textX, predY);
                        predY += 10;
                    }
                    yPos += thumbSize + 10;
                }
            }

            const watermark1 = "FOR RESEARCH PURPOSES ONLY"; const watermark2 = "NOT FOR MEDICAL DIAGNOSIS";
            const totalPages = pdf.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                pdf.setPage(i);
                pdf.setFontSize(40).setTextColor(200, 200, 200).setGState(new pdf.GState({opacity: 0.2})); // Opaklık artırıldı
                pdf.text(watermark1, pageWidth / 2, pageHeight * 0.25, null, 45, 'center');
                pdf.text(watermark2, pageWidth / 2, pageHeight * 0.75, null, -45, 'center');
                pdf.text(watermark1, pageHeight * 0.25, pageHeight / 2, null, -45, 'center');
                pdf.text(watermark2, pageWidth - (pageHeight * 0.25), pageHeight / 2, null, 45, 'center');
                pdf.setGState(new pdf.GState({opacity: 1}));

                if (i === totalPages) {
                    const qr = qrcode(0, 'L');
                    const qrUrl = `${window.location.origin}${window.location.pathname}#${currentResultId}`;
                    qr.addData(qrUrl);
                    qr.make();
                    const qrImgData = qr.createDataURL(4);
                    pdf.addImage(qrImgData, 'PNG', pageWidth - margin - 50, pageHeight - margin - 50, 50, 50);
                }
            }

            pdf.save('brAIn-analysis-report.pdf');
            btn.querySelector('span').textContent = translations[currentLang].btnDownloadReport;
            btn.disabled = false;
        }

        function checkUrlForResults() {
            if(window.location.hash) {
                const resultId = window.location.hash.substring(1);
                const savedResults = sessionStorage.getItem(resultId);
                if (savedResults) {
                    const data = JSON.parse(savedResults);
                    batchResults = data.valid || []; invalidImages = data.invalid || []; currentResultId = resultId;
                    displayBatchResults();
                }
            }
        }
        
        aboutBtn.addEventListener('click', () => aboutModal.classList.add('visible'));
        closeModalBtn.addEventListener('click', () => aboutModal.classList.remove('visible'));
        aboutModal.addEventListener('click', (e) => { if(e.target === aboutModal) aboutModal.classList.remove('visible'); });
        document.querySelectorAll('.lang-link').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); changeLanguage(e.target.dataset.lang); }); });
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        dropZone.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'rgba(255, 255, 255, 0.05)'; });
        dropZone.addEventListener('dragleave', e => { e.currentTarget.style.backgroundColor = 'transparent'; });
        dropZone.addEventListener('drop', e => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'transparent'; handleFiles(e.dataTransfer.files); });
        cameraBtn.addEventListener('click', startCamera);
        captureBtn.addEventListener('click', handleCameraCapture);
        cancelCameraBtn.addEventListener('click', resetApp);
        pdfBtn.addEventListener('click', generatePDF);
        tryAgainBtn.addEventListener('click', resetApp);
        scanAnotherBtn.addEventListener('click', resetApp);

        const savedLang = localStorage.getItem('brain-lang') || 'en';
        changeLanguage(savedLang);
        loadModel();
        checkUrlForResults();
    </script>
</body>
</html>
